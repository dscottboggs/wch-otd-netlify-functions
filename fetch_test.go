/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

package wch_otd_api

import (
	"encoding/json"
	"os"
	"strings"
	"testing"
	"time"

	"github.com/dscottboggs/attest"
)

func TestMakeUrl(t *testing.T) {
	test := attest.New(t)
	date := time.Date(2023, 4, 20, 0, 0, 0, 0, time.Local)
	test.Equals(
		makeUrl(&date).String(),
		"https://api.baserow.io/api/database/rows/table/33215/?filter__field_177139__equal=4&filter__field_177140__equal=20&size=100&user_field_names=true",
	)
}

func TestWhatever(t *testing.T) {
	data := `{"count": 4,"next": null,"previous": null,"results":[{"id": 9243,"order": "1969.00000000000000000000","title": "Ludlow Massacre","year": "1914","month": "4","day": "20","time": "","description": "<p>On 20 April 1914, the Ludlow massacre took place when US troops opened fire with machine guns on a camp of striking miners and their families in Ludlow, Colorado.</p> <p>12,000 miners had gone out on strike the previous September against the Rockefeller family-owned Colorado Fuel and Iron Corporation (CF&amp;I) following the killing of an activist of the United Mine Workers of America (UMWA). They then demanded better safety at work, and to be paid in money, instead of company scrip (tokens which could only be redeemed in the company store).</p> <p>The Rockefellers evicted the striking miners and their families from their homes, and so they set up \"tent cities\" to live in collectively, which miners' wives helped run. Company thugs harassed strikers, and occasionally drove by camps riddling them with machine-gun fire, killing and injuring workers and their children.</p> <p>Eventually, the national guard was ordered to evict all the strike encampments, and the morning of April 20 they attacked the largest camp in Ludlow. They opened fire with machine guns on the tents of the workers and their families, who then returned fire. The main organiser of the camp, Louis Tikas, went to visit the officer in charge of the national guard to arrange a truce. But he was beaten to the ground then shot repeatedly in the back, killing him. That night, troops entered the camp and set fire to it, killing 11 children and two women, in addition to 13 other people who were killed in the fighting. The youngest victim was Elvira Valdez, aged just 3 months.</p> <p>Protests against the massacre broke out across the country, but the workers at CF&amp;I were defeated, and many of them were subsequently sacked and replaced with non-union miners. Over the course of the strike 66 people were killed, but no guardsmen or company thugs were prosecuted.</p>","social_description": null,"media": "https://workingclasshistory.com/wp-content/uploads/2023/02/04.20-x-Ludlow_striker_family_in_front_of_tent.jpg","media_credit": "Denver Library/Wikimedia Commons","media_caption": "Striking miners wives and children in the strikers' tent camp, 1914","sources": "<ul> <li>The Ludlow massacre, 1914 &ndash; Sam Lowry, Libcom.org, <a href=\"https://libcom.org/history/articles/ludlow-massacre-1914\">https://libcom.org/history/articles/ludlow-massacre-1914</a> accessed 10/08/2019.</li> <li>Ludlow massacre &ndash; <em>Encyclopaedia Britannica</em> &ndash; <a href=\"https://www.britannica.com/event/Ludlow-Massacre\">https://www.britannica.com/event/Ludlow-Massacre</a> accessed 10/08/2019</li> </ul>","latitude": "37.3393122868","longitude": "-104.5839659236","geotag_info": "Exact location","geotag_description": "Here, just north-east of the junction of County Road 61.5 and the 44, is where the massacre occurred.","visitor_info": "The site is now home to the Ludlow Memorial Park, which has an exhibit, a monument, and preserved items from the massacre.","author_name": "Working Class History","author_url": "https://workingclasshistory.com","author_email": "","created_at": "2022-07-19","status":{"id": 17945,"value": "published","color": "dark-gray"},"reviwer_id": [],"translations": [],"categories": [],"tags":[{"id": 7661,"value": "United States"},{"id": 7663,"value": "unions"},{"id": 7664,"value": "military"},{"id": 7690,"value": "strikes"},{"id": 7724,"value": "repression"},{"id": 7770,"value": "killings"},{"id": 7876,"value": "mining"},{"id": 7943,"value": "evictions"},{"id": 7944,"value": "health and safety"},{"id": 8002,"value": "Massachusetts"},{"id": 8550,"value": "massacres"},{"id": 9154,"value": "United Mine Workers of America"},{"id": 11488,"value": "John D. Rockefeller"},{"id": 11489,"value": "Louis Tikas"},{"id": 11490,"value": "Elvira Valdez"},{"id": 11491,"value": "Ludlow"},{"id": 11492,"value": "Ludlow massacre"},{"id": 11493,"value": "Colorado Fuel and Iron Corporation"}],"preview_text": null,"more_info": "","extra_media_media": [],"extra_media_caption": [],"extra_media_credit": [],"extra_media": [],"updated_at": "2023-04-20T16:18:04.525537Z","podcast_url": "","books_url": "","merch_url": "","spreadsheet_ref": "1904"},{"id": 9244,"order": "1970.00000000000000000000","title": "Maria Silva Cruz born","year": "1915","month": "4","day": "20","time": "","description": "On 20 April 1915, Maria Silva Cruz, heroine of the Casas Viejas uprising was born into a family of day labourers and charcoal burners. Following the tragically unsuccessful uprising in 1933, she was the sole survivor when Republican civil guards set fire to her grandfather's house, killing the other five occupants and forcing her to flee with her hair and clothes in flames. More information in this short biography: https://libcom.org/history/silva-cruz-maria","social_description": null,"media": "","media_credit": "","media_caption": "","sources": "https://libcom.org/history/silva-cruz-maria","latitude": "36.3422762200","longitude": "-5.8115671420","geotag_info": "Exact location","geotag_description": "Here, just north of the corner of Calle Independencia and Calle Dr Rafael Bernal, is where Cruz's shack was located.","visitor_info": "The shack was destroyed and there is now a hotel on the site called Hotel Utopia, in reference to the uprising.","author_name": "Working Class History","author_url": "https://workingclasshistory.com","author_email": "","created_at": "2022-07-19","status":{"id": 17945,"value": "published","color": "dark-gray"},"reviwer_id": [],"translations": [],"categories": [],"tags":[{"id": 7671,"value": "Spain"},{"id": 7675,"value": "Spanish civil war"},{"id": 7698,"value": "births"},{"id": 7710,"value": "uprisings"},{"id": 7724,"value": "repression"},{"id": 7735,"value": "women"},{"id": 7773,"value": "fascism"},{"id": 7791,"value": "Confederación Nacional del Trabajo"},{"id": 8610,"value": "Casas Viejas uprising"},{"id": 11494,"value": "Maria Silva Cruz"},{"id": 11495,"value": "Casas Viejas"}],"preview_text": null,"more_info": "","extra_media_media": [],"extra_media_caption": [],"extra_media_credit": [],"extra_media": [],"updated_at": "2023-04-19T22:29:41.192834Z","podcast_url": "","books_url": "","merch_url": "","spreadsheet_ref": "1905"},{"id": 9245,"order": "1971.00000000000000000000","title": "Limerick youth clashes","year": "1919","month": "4","day": "20","time": "","description": "On 20 April 1919, 1,000 youths confronted soldiers in one of the major flashpoints of the Limerick Soviet in Ireland. The Limerick Trades and Labour Council had become a strike committee, and it was effectively running the city during a general strike against the imposition of an onerous pass system by the British military. \nIn addition to printing their own currency (pictured), they established an amusement committee that reopened the cinema, diverting profits to the strike fund. They also printed posters advertising a hurling match at Caherdavin, a suburb that lay across the River Shannon and outside the restricted zone. \nAfter the match, 1,000 youths approached the army check point on Sarsfield Bridge, without the permits that permitted their re-entry to Limerick. A sentry fired warning shots and his colleagues scrambled from inside the Shannon Rowing Club where they were billeted. An armoured car and whippet tank blocked the bridge and a machine gun was readied on the upper storey of the Rowing Club. \nBloodshed was avoided when the youths retreated from the restricted area and organised a concert and dance at St Munchin’s Temperance Hall.","social_description": null,"media": "https://workingclasshistory.com/wp-content/uploads/2022/07/04.20-Limerick-Soviet-currency-green-fair-use.jpg","media_credit": "The Workers of Limerick","media_caption": "A banknote issued by the Limerick Soviet.","sources": "<p>Cahill, Liam (1990). <em>Forgotten Revolution: Limerick Soviet, 1919</em>. Dublin: O'Brien Press. Available at: <a href=\"https://libcom.org/history/forgotten-revolution-limerick-soviet-1919-liam-cahill;\">https://libcom.org/history/forgotten-revolution-limerick-soviet-1919-liam-cahill</a>&nbsp;(accessed: 20 April 2023)</p> <p>O'Connor Lysaght, DR (1979). 'The story of the Limerick soviet, 1919'. Available at: <a href=\"https://libcom.org/library/1919-story-limerick-soviet\">https://libcom.org/library/1919-story-limerick-soviet</a> (accessed: 20 April 2023)</p>","latitude": "52.6649093200","longitude": "-8.6293556360","geotag_info": "Exact location","geotag_description": "This was the site of an army checkpoint during the Limerick Soviet","visitor_info": "Completed in 1835, the bridge’s five stone arches cross the River via a man-made island, which during the Limerick Soviet was the site of an important army checkpoint. The original monument on the bridge, a statue commemorating the Charge of the Light Brigade, was blown up by the IRA in 1930. In its place there now stands a monument to those who died during and after the failed 1916 uprising. Facing the monument, perched on the artificial island, stands the elaborate Edwardian clubhouse of the Shannon Rowing Club, where British soldiers were billeted in April 1919.","author_name": "D.D. Johnston","author_url": "","author_email": "","created_at": "2022-07-19","status":{"id": 17945,"value": "published","color": "dark-gray"},"reviwer_id": [],"translations": [],"categories": [],"tags":[{"id": 7663,"value": "unions"},{"id": 7690,"value": "strikes"},{"id": 7767,"value": "Ireland"},{"id": 7825,"value": "workers' control"},{"id": 7842,"value": "nationalism"},{"id": 8066,"value": "general strikes"},{"id": 8635,"value": "Irish Transport and General Workers Union"},{"id": 9332,"value": "Irish Republican Army"},{"id": 9553,"value": "Limerick Trades and Labour Council"},{"id": 9554,"value": "Limerick"},{"id": 9555,"value": "Limerick Soviet"}],"preview_text": null,"more_info": "","extra_media_media": [],"extra_media_caption": [],"extra_media_credit": [],"extra_media": [],"updated_at": "2023-04-20T10:28:22.310421Z","podcast_url": "","books_url": "","merch_url": "","spreadsheet_ref": "1906"},{"id": 11248,"order": "3800.00000000000000000000","title": "Palestinian general strike","year": "1936","month": "4","day": "20","time": "","description": "<p>On 20 April 1936, an Arab National Committee was formed in Nablus, Palestine, and resolved to call a general strike across the then-British colony. On April 21, other Palestinian leaders met and agreed to support the strike call, which would call out all Palestinian Arabs engaged in labour, transport and retail the following day.</p> <p>Zionists were escalating their efforts to colonise the country, Jewish immigration from Europe had increased, and groups like the Jewish Colonisation Association were establishing settlements and buying up huge swathes of land with open intentions of forming a Jewish colonial ethno-state.</p> <p>In response, the strikers demanded: a stop to Jewish immigration; prohibition of Arab Palestinian land being transferred to Jewish settlers; and the establishment of a democratic government.</p> <p>The general strike was a key early escalation in what became known as the Arab revolt of 1936. The following month, Palestinians also began to withhold taxes, and armed insurrection broke out in the countryside.</p> <p>British authorities responded with violent repression, drafting in thousands of soldiers, and enlisting armed Zionists and Zionists in the police force to help crush the rebellion. Britain declared martial law, and British and Zionist forces killed up to 5000 Arabs, wounded up to 15,000, arrested 9000 and blew up thousands of homes, leaving tens of thousands of Palestinians homeless.</p> <p>In October, the Arab Higher Committee called off the strike and the revolt, but rebellion of poor peasants in the countryside continued until 1939. Eventually, British and Zionist repression succeeded in gradually crushing the movement. Although a British government White Paper, issued in 1939, did make concessions to Palestinians, agreeing to limit Jewish immigration and land purchases, and consider establishing an independent Palestinian state within 10 years. But these were not later honoured.</p>","social_description": null,"media": "","media_credit": "","media_caption": "","sources": "The 1936 Palestine strike: A history of Palestinian revolt, Middle East Eye, May 18, 2021, accessed July 14, 2022, https://www.middleeasteye.net/news/palestine-strike-history-explained-revolt; Mustafa Kabha. “The Palestinian Press and the General Strike, April-October 1936: ‘Filastin’ as a Case Study.” Middle Eastern Studies 39, no. 3 (2003): 169–89. http://www.jstor.org/stable/4284312; Clifford A. Wright, Facts and Fables: The Arab-Israeli Conflict (Taylor & Francis, 2015); Theodore Norman, An outstretched arm: a history of the Jewish Colonization Association (Routledge & Kegan Paul, 1985), accessed July 14, 2022, https://archive.org/details/cu31924011030396/mode/2up.","latitude": "32.2260445240","longitude": "35.2534223996","geotag_info": "In this town/city","geotag_description": "In this city, Nablus, is where the April 20 meeting took place.","visitor_info": "If you know the exact location of the meeting please email us on info@workingclasshistory.com.","author_name": "Working Class History","author_url": "https://workingclasshistory.com","author_email": "","created_at": "2023-04-19","status":{"id": 17945,"value": "published","color": "dark-gray"},"reviwer_id": [],"translations": [],"categories": [],"tags":[{"id": 7690,"value": "strikes"},{"id": 7721,"value": "United Kingdom"},{"id": 7722,"value": "colonialism"},{"id": 7873,"value": "agriculture"},{"id": 8066,"value": "general strikes"},{"id": 8109,"value": "boycotts"},{"id": 8674,"value": "taxes"},{"id": 8829,"value": "Haganah"},{"id": 8830,"value": "Jewish Colonisation Association"},{"id": 8831,"value": "Arab National Committee"},{"id": 8832,"value": "Palestine"},{"id": 8833,"value": "Israel"},{"id": 14058,"value": "Arab revolt"}],"preview_text": null,"more_info": "","extra_media_media": [],"extra_media_caption": [],"extra_media_credit": [],"extra_media": [],"updated_at": "2023-04-19T19:38:49.917770Z","podcast_url": "","books_url": "","merch_url": "","spreadsheet_ref": "469"}]}`
	test := attest.NewImmediate(t)
	var dbResponse DbResponse
	test.Handle(json.NewDecoder(strings.NewReader(data)).Decode(&dbResponse))
	transformed := test.EatError(dbResponse.Transform()).(DaysData)
	f := test.EatError(os.Create("/tmp/output")).(*os.File)
	test.Handle(json.NewEncoder(f).Encode(transformed))
}
